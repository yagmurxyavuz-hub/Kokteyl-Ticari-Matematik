<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>ÅiÅŸe & Kokteyl Maliyet Hesap</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{--pad:16px;--radius:18px;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111;display:flex;min-height:100svh;align-items:center;justify-content:center}
  .card{width:min(720px,95vw);background:#fff;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.08);padding:var(--pad)}
  h1{font-size:clamp(20px,5vw,26px);margin:0 0 6px}
  p.sub{margin:.25rem 0 1rem;color:#555;font-size:14px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin:8px 0 14px}
  @media(min-width:560px){.grid{grid-template-columns:1fr 1fr}}
  label{font-size:12px;color:#555;margin-bottom:6px;display:block}
  .input{display:flex;align-items:center;border:1px solid #e3e6ee;border-radius:12px;padding:10px 12px;gap:8px;background:#fff}
  .input span{opacity:.7;font-size:14px;white-space:nowrap}
  .input input{flex:1;border:0;outline:none;font-size:16px;min-width:0;background:transparent}
  .input input[readonly]{opacity:.9}
  .hint{font-size:12px;color:#666;margin-top:2px}
  .result{display:grid;gap:10px;margin-top:12px}
  .tile{border:1px solid #e9edf6;border-radius:14px;padding:12px 14px;background:#0f172a;color:#fff}
  .tile.light{background:#fff;color:#111}
  .tile .k{opacity:.8;font-size:12px}
  .tile .v{font-size:18px;font-weight:600;margin-top:2px;word-break:break-word}
  .btns{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
  button{border:0;border-radius:12px;padding:12px 14px;font-size:15px;cursor:pointer}
  .primary{background:#4f46e5;color:#fff}
  .ghost{background:#eef2ff;color:#111}
  .danger{background:#fee2e2;color:#991b1b}
  .footer{margin-top:10px;color:#666;font-size:12px;text-align:center}
  hr{border:none;border-top:1px solid #eef2ff;margin:6px 0}

  /* MODERN DROPDOWN (overlay) */
  .dropdown-panel{
    position:fixed; inset:0;
    background:rgba(15,23,42,.35);
    display:none; align-items:center; justify-content:center;
    padding:18px; z-index:999;
  }
  .dropdown-card{
    width:min(620px, 96vw);
    background:#fff;
    border-radius:16px;
    border:1px solid #e9edf6;
    box-shadow:0 20px 60px rgba(0,0,0,.18);
    overflow:hidden;
  }
  .dropdown-head{padding:12px;border-bottom:1px solid #eef2ff;background:#fafbff}
  .dropdown-listbox{max-height:55vh;overflow:auto}
  .dropdown-item{
    padding:12px 14px; cursor:pointer; font-size:14px;
    border-bottom:1px solid #f1f5ff;
  }
  .dropdown-item:hover{background:#eef2ff}
  .row2{display:flex;gap:10px}
  .row2 > *{flex:1}
</style>
</head>

<body>
<main class="card">
  <h1>ÅiÅŸe & Kokteyl Maliyet Hesap</h1>
  <p class="sub">ÃœrÃ¼n seÃ§ â†’ fiyat & CL dosyadan gelsin. Ä°skonto % ile net fiyatÄ± dÃ¼ÅŸer. Kokteyl maliyeti ve kÃ¢rÄ± hesaplanÄ±r.</p>

  <div class="grid">
    <!-- ÃœRÃœN SEÃ‡ (MODERN DROPDOWN) -->
    <div>
      <label>ÃœrÃ¼n SeÃ§</label>
      <div class="input" id="urunTrigger" style="cursor:pointer">
        <span>ğŸ”</span>
        <input id="urunSelected" placeholder="ÃœrÃ¼n seÃ§..." readonly>
      </div>
      <div class="hint">ÃœrÃ¼nler urunler.csv dosyasÄ±ndan okunur</div>
    </div>

    <div>
      <label for="price">ÅiÅŸe FiyatÄ± (dosyadan)</label>
      <div class="input"><span>â‚º</span><input id="price" type="number" step="any" placeholder="â€”" readonly></div>
    </div>

    <div>
      <label for="cl">ÅiÅŸe CL (dosyadan)</label>
      <div class="input"><span>CL</span><input id="cl" type="number" step="any" placeholder="â€”" readonly></div>
    </div>

    <div>
      <label for="discPct">Ä°skonto (%)</label>
      <div class="input"><span>%</span><input id="discPct" type="number" step="any" placeholder="10"></div>
      <div class="hint">Ä°skonto yÃ¼zde olarak ÅŸiÅŸe fiyatÄ±ndan dÃ¼ÅŸÃ¼lÃ¼r</div>
    </div>

    <hr>

    <div>
      <label for="usecl">Kokteylâ€™de KullanÄ±lan Alkol (CL)</label>
      <div class="input"><span>CL</span><input id="usecl" type="number" step="any" placeholder="5"></div>
    </div>

    <div>
      <label for="other">DiÄŸer Maliyet (1 kokteyl)</label>
      <div class="input"><span>â‚º</span><input id="other" type="number" step="any" placeholder="20"></div>
      <div class="hint">Limon, ÅŸurup, garnish vb. (tek kokteyl)</div>
    </div>

    <div>
      <label for="sale">Kokteyl SatÄ±ÅŸ FiyatÄ± (1 adet)</label>
      <div class="input"><span>â‚º</span><input id="sale" type="number" step="any" placeholder="150"></div>
    </div>

    <div>
      <label for="qty">Kokteyl Adedi</label>
      <div class="input"><span>Adet</span><input id="qty" type="number" step="1" placeholder="1" value="1" readonly></div>
    </div>
  </div>

  <section class="result">
    <div class="tile"><div class="k">Net ÅiÅŸe FiyatÄ± (iskonto sonrasÄ±)</div><div class="v" id="netOut">â€”</div></div>
    <div class="tile light"><div class="k">â‚º / CL</div><div class="v" id="perCL">â€”</div></div>

    <div class="tile"><div class="k">Kokteyl Alkol Maliyeti (1 adet)</div><div class="v" id="alcCost">â€”</div></div>
    <div class="tile light"><div class="k">Toplam Kokteyl Maliyeti (1 adet)</div><div class="v" id="cocktailCost">â€”</div></div>

    <div class="tile"><div class="k">KÃ¢r (1 kokteyl)</div><div class="v" id="profitOne">â€”</div></div>
    <div class="tile light"><div class="k">Toplam KÃ¢r (adet)</div><div class="v" id="profitTotal">â€”</div></div>
    <div class="tile light"><div class="k">KÃ¢r OranÄ±</div><div class="v" id="profitPct">â€”</div></div>
  </section>

  <div class="btns">
    <button class="ghost" id="copyBtn">SonuÃ§larÄ± kopyala</button>
    <button class="danger" id="resetBtn">SÄ±fÄ±rla</button>
  </div>

  <div class="footer">GÃ¼ncelleme gÃ¶rÃ¼nmÃ¼yorsa Ctrl+F5 yapÄ±n veya Service Worker cache temizleyin.</div>
</main>

<!-- ÃœRÃœN SEÃ‡ PANELÄ° -->
<div id="urunPanel" class="dropdown-panel" aria-hidden="true">
  <div class="dropdown-card" role="dialog" aria-modal="true">
    <div class="dropdown-head">
      <div class="input">
        <span style="opacity:.7">Ara</span>
        <input id="urunSearch" placeholder="Yazmaya baÅŸla...">
      </div>
      <div class="hint" id="urunInfo" style="margin-top:8px">Liste yÃ¼kleniyorâ€¦</div>
    </div>
    <div id="urunList" class="dropdown-listbox"></div>
  </div>
</div>

<script>
/* -----------------------------
   Helpers
----------------------------- */
const $ = (s)=>document.querySelector(s);
function fmtTL(n){
  if(!Number.isFinite(n)) return "â€”";
  return "â‚º " + n.toLocaleString(undefined,{maximumFractionDigits:2});
}
function fmtPct(n){
  if(!Number.isFinite(n)) return "â€”";
  return "% " + n.toFixed(1).replace('.',',');
}
function cleanName(s){
  return String(s ?? "")
    .trim()
    .replace(/^[\uFEFF\s"â€œâ€']+/, "")
    .replace(/["â€œâ€'\s]+$/, "");
}
function toNum(s){
  if(s == null) return NaN;
  const str = String(s).trim();
  if(!str) return NaN;
  const normalized = (str.includes(",") && str.includes("."))
    ? str.replace(/\./g,"").replace(",",".")
    : str.replace(",",".");
  const n = Number(normalized);
  return Number.isFinite(n) ? n : NaN;
}

/* -----------------------------
   Elements
----------------------------- */
const els = {
  urunTrigger: $("#urunTrigger"),
  urunPanel: $("#urunPanel"),
  urunSelected: $("#urunSelected"),
  urunSearch: $("#urunSearch"),
  urunList: $("#urunList"),
  urunInfo: $("#urunInfo"),

  price: $("#price"),
  cl: $("#cl"),
  discPct: $("#discPct"),
  usecl: $("#usecl"),
  other: $("#other"),
  sale: $("#sale"),
  qty: $("#qty"),
};

const out = {
  netOut: $("#netOut"),
  perCL: $("#perCL"),
  alcCost: $("#alcCost"),
  cocktailCost: $("#cocktailCost"),
  profitOne: $("#profitOne"),
  profitTotal: $("#profitTotal"),
  profitPct: $("#profitPct"),
};

let urunler = [];

/* -----------------------------
   Modern Dropdown Open/Close
----------------------------- */
function openPanel(){
  els.urunPanel.style.display="flex";
  els.urunPanel.setAttribute("aria-hidden","false");
  els.urunSearch.value="";
  renderUrunList(urunler);
  setTimeout(()=>els.urunSearch.focus(), 0);
}
function closePanel(){
  els.urunPanel.style.display="none";
  els.urunPanel.setAttribute("aria-hidden","true");
}
els.urunTrigger.addEventListener("click", openPanel);
els.urunPanel.addEventListener("click", (e)=>{
  if(e.target === els.urunPanel) closePanel();
});
document.addEventListener("keydown",(e)=>{
  if(e.key === "Escape" && els.urunPanel.style.display==="flex") closePanel();
});

/* -----------------------------
   CSV Load (virgÃ¼l / ; destekli)
   Beklenen kolonlar: ad,fiyat,cl  (sÄ±ra Ã¶nemli)
----------------------------- */
fetch("urunler.csv")
  .then(r => {
    if (!r.ok) throw new Error("urunler.csv bulunamadÄ±");
    return r.text();
  })
  .then(text => {
    const cleaned = text.replace(/\r/g, "").trim();
    const lines = cleaned.split("\n");
    if (lines.length <= 1) throw new Error("CSV boÅŸ veya sadece baÅŸlÄ±k var");

    // delimiter'Ä± header'dan tahmin et
    const header = lines[0];
    const delimiter = header.includes(";") && !header.includes(",") ? ";" : ",";

    const dataLines = lines.slice(1);

    urunler = dataLines.map(line => {
      let s = line.trim();
      if (!s) return null;

      // SatÄ±r komple "..." ÅŸeklinde geliyorsa tÄ±rnaklarÄ± kaldÄ±r
      if (s.startsWith('"') && s.endsWith('"')) s = s.slice(1, -1);

      // ÃœrÃ¼n adÄ±nda ayraÃ§ olabilir â†’ sondan 2 ayraÃ§tan bÃ¶l
      const lastSep = s.lastIndexOf(delimiter);
      const secondLastSep = s.lastIndexOf(delimiter, lastSep - 1);
      if (lastSep === -1 || secondLastSep === -1) return null;

      const adRaw = s.slice(0, secondLastSep);
      const fiyatRaw = s.slice(secondLastSep + 1, lastSep);
      const clRaw = s.slice(lastSep + 1);

      const ad = cleanName(adRaw);
      const fiyat = toNum(fiyatRaw);
      const cl = toNum(clRaw);

      if (!ad || !Number.isFinite(fiyat) || !Number.isFinite(cl)) return null;
      return { ad, fiyat, cl };
    }).filter(Boolean);

    els.urunInfo.textContent = `Toplam ${urunler.length} Ã¼rÃ¼n yÃ¼klendi`;
    renderUrunList(urunler);
  })
  .catch(err => {
    console.error(err);
    els.urunInfo.textContent = "ÃœrÃ¼n listesi yÃ¼klenemedi. urunler.csv formatÄ±nÄ± kontrol edin.";
  });

/* -----------------------------
   Render + Filter + Select
----------------------------- */
function renderUrunList(list){
  els.urunList.innerHTML="";
  if(!list || list.length === 0){
    const empty = document.createElement("div");
    empty.className="dropdown-item";
    empty.textContent="SonuÃ§ bulunamadÄ±";
    empty.style.opacity=".7";
    els.urunList.appendChild(empty);
    return;
  }

  list.slice(0, 400).forEach(u=>{
    const div=document.createElement("div");
    div.className="dropdown-item";
    div.textContent=u.ad;
    div.onclick=()=>{
      els.urunSelected.value=u.ad;
      els.price.value=u.fiyat;
      els.cl.value=u.cl;
      closePanel();
      calc();
    };
    els.urunList.appendChild(div);
  });
}

els.urunSearch.addEventListener("input", ()=>{
  const q = els.urunSearch.value.toLowerCase();
  const filtered = urunler.filter(u=>u.ad.toLowerCase().includes(q));
  renderUrunList(filtered);
});

/* -----------------------------
   Calculation
----------------------------- */
function calc(){
  const P = toNum(els.price.value);
  const CL = toNum(els.cl.value);
  const discPct = toNum(els.discPct.value);
  const U = toNum(els.usecl.value);
  const O = toNum(els.other.value);
  const S = toNum(els.sale.value);
  let Q = 1;
if (Number.isFinite(CL) && CL > 0 && Number.isFinite(U) && U > 0) {
  Q = Math.max(1, Math.floor(CL / U)); // tam kokteyl adedi
}
els.qty.value = String(Q);

  const pct = Number.isFinite(discPct) ? discPct : 0;
  const net = Math.max(0, P - (P * pct / 100));

  const perCL = net / CL;
  const alcCost = (Number.isFinite(perCL) && Number.isFinite(U)) ? perCL * U : NaN;

  const other = Number.isFinite(O) ? O : 0;
  const cocktailCost = (Number.isFinite(alcCost) ? alcCost : 0) + other;

  const sale = Number.isFinite(S) ? S : NaN;
  const profitOne = (Number.isFinite(sale) ? sale : 0) - cocktailCost;
  const profitTotal = profitOne * Q;

  const profitPct = (Number.isFinite(sale) && sale > 0)
    ? (profitOne / sale) * 100
    : NaN;

  out.netOut.textContent = fmtTL(net);
  out.perCL.textContent = fmtTL(perCL);
  out.alcCost.textContent = fmtTL(alcCost);
  out.cocktailCost.textContent = fmtTL(cocktailCost);
  out.profitOne.textContent = fmtTL(profitOne);
  out.profitTotal.textContent = fmtTL(profitTotal);
  out.profitPct.textContent = fmtPct(profitPct);
}

["discPct","usecl","other","sale"].forEach(id=>{
  els[id].addEventListener("input", calc);
});

$("#resetBtn").addEventListener("click", ()=>{
  els.urunSelected.value = "";
  els.price.value = "";
  els.cl.value = "";
  els.discPct.value = "";
  els.usecl.value = "";
  els.other.value = "";
  els.sale.value = "";
  els.qty.value = "1";
  Object.values(out).forEach(el=>el.textContent="â€”");
});

$("#copyBtn").addEventListener("click", ()=>{
  const lines = [
    "Net ÅiÅŸe FiyatÄ±: " + out.netOut.textContent,
    "â‚º / CL: " + out.perCL.textContent,
    "Kokteyl Alkol Maliyeti (1): " + out.alcCost.textContent,
    "Toplam Kokteyl Maliyeti (1): " + out.cocktailCost.textContent,
    "KÃ¢r (1): " + out.profitOne.textContent,
    "Toplam KÃ¢r: " + out.profitTotal.textContent,
    "KÃ¢r OranÄ±: " + out.profitPct.textContent,
  ].join("\n");
  navigator.clipboard?.writeText(lines).then(()=>{
    $("#copyBtn").textContent = "KopyalandÄ±";
    setTimeout(()=>$("#copyBtn").textContent="SonuÃ§larÄ± kopyala",1200);
  });
});

calc();

window.addEventListener("load", ()=>{
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(console.error);
  }
});
</script>


