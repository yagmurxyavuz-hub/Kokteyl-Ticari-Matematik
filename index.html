<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>ÅiÅŸe & Kokteyl Maliyet Tahminlemesi</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#00205B" />

  <!-- Favicons (relative paths; GitHub Pages project path ise dosyalarÄ± aynÄ± klasÃ¶rde tut) -->
  <link rel="icon" href="favicon.ico?v=7" sizes="any" />
  <link rel="shortcut icon" href="favicon.ico?v=7" />
  <link rel="icon" type="image/png" href="icons/icon-192.png?v=7" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root{--pad:16px;--radius:18px;}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#00205B;color:#111;display:flex;min-height:100svh;align-items:center;justify-content:center}
    .card{width:min(720px,95vw);background:#fff;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.08);padding:var(--pad)}
    h1{font-size:clamp(20px,5vw,26px);margin:0 0 6px}
    p.sub{margin:.25rem 0 1rem;color:#555;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin:8px 0 14px}
    @media(min-width:560px){.grid{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:#555;margin-bottom:6px;display:block}
    .input{display:flex;align-items:center;border:1px solid #e3e6ee;border-radius:12px;padding:10px 12px;gap:8px;background:#fff}
    .input span{opacity:.7;font-size:14px;white-space:nowrap}
    .input input{flex:1;border:0;outline:none;font-size:16px;min-width:0;background:transparent}
    .input input[readonly]{opacity:.9}
    .hint{font-size:12px;color:#666;margin-top:2px}
    .result{display:grid;gap:10px;margin-top:12px}
    .tile{border:1px solid #e9edf6;border-radius:14px;padding:12px 14px;background:#0f172a;color:#fff}
    .tile.light{background:#fff;color:#111}
    .tile .k{opacity:.8;font-size:12px}
    .tile .v{font-size:18px;font-weight:600;margin-top:2px;word-break:break-word}
    .btns{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:12px 14px;font-size:15px;cursor:pointer}
    .danger{background:#fee2e2;color:#991b1b}
    .footer{margin-top:10px;color:#666;font-size:12px;text-align:center}
    hr{border:none;border-top:1px solid #eef2ff;margin:6px 0}

    .dropdown-panel{
      position:fixed; inset:0;
      background:rgba(15,23,42,.35);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:999;
    }
    .dropdown-card{
      width:min(620px, 96vw);
      background:#fff;
      border-radius:16px;
      border:1px solid #e9edf6;
      box-shadow:0 20px 60px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .dropdown-head{padding:12px;border-bottom:1px solid #eef2ff;background:#fafbff}
    .dropdown-listbox{max-height:55vh;overflow:auto}
    .dropdown-item{
      padding:12px 14px; cursor:pointer; font-size:14px;
      border-bottom:1px solid #f1f5ff;
    }
    .dropdown-item:hover{background:#eef2ff}
  </style>
</head>

<body>
<main class="card">
  <h1>ÅiÅŸe & Kokteyl Maliyet Hesap</h1>
  <p class="sub"></p>

  <div class="grid">
    <div>
      <label>ÃœrÃ¼n SeÃ§</label>
      <div class="input" id="urunTrigger" style="cursor:pointer">
        <span>ğŸ”</span>
        <input id="urunSelected" placeholder="ÃœrÃ¼n seÃ§..." readonly />
      </div>
    </div>

    <div>
      <label for="price">DistribÃ¼tÃ¶r On Trade SatÄ±ÅŸ FiyatÄ± (dosyadan)</label>
      <div class="input"><span>â‚º</span><input id="price" type="number" step="any" placeholder="â€”" readonly /></div>
    </div>

    <div>
      <label for="cl">ÅiÅŸe CL (dosyadan)</label>
      <div class="input"><span>CL</span><input id="cl" type="number" step="any" placeholder="â€”" readonly /></div>
    </div>

    <div>
      <label for="discPct">Ä°skonto (%)</label>
      <div class="input"><span>%</span><input id="discPct" type="number" step="any" placeholder="10" /></div>
      <div class="hint">Pernod Ricard TarafÄ±nan KarÅŸÄ±lanan Ä°skonto OranÄ±dÄ±r</div>
    </div>

    <hr>

    <div>
      <label for="usecl">Kokteylâ€™de KullanÄ±lan Alkol (CL)</label>
      <div class="input"><span>CL</span><input id="usecl" type="number" step="any" placeholder="5" /></div>
    </div>

    <div>
      <label for="other">DiÄŸer Maliyet (1 kokteyl)</label>
      <div class="input"><span>â‚º</span><input id="other" type="number" step="any" placeholder="20" /></div>
      <div class="hint">Limon, ÅŸurup, garnish vb. (tek kokteyl)</div>
    </div>

    <div>
      <label for="sale">Nokta MenÃ¼sÃ¼ndeki Kokteyl SatÄ±ÅŸ FiyatÄ± (1 adet)</label>
      <div class="input"><span>â‚º</span><input id="sale" type="number" step="any" placeholder="150" /></div>
      <div class="hint">Nokta tarafÄ±ndan belirlenen kokteyl satÄ±ÅŸ fiyatÄ±dÄ±r</div>
    </div>

    <div>
      <label for="qty">Kokteyl Adedi (ÅŸiÅŸeden Ã§Ä±kan)</label>
      <div class="input"><span>Adet</span><input id="qty" type="number" step="1" value="1" readonly /></div>
    </div>
  </div>

  <section class="result">
    <div class="tile">
      <div class="k">Net ÅiÅŸe FiyatÄ± (iskonto sonrasÄ±)</div>
      <div class="v" id="netOut">â€”</div>
    </div>

    <div class="tile light">
      <div class="k">Toplam Kokteyl Maliyeti (1 adet)</div>
      <div class="v" id="cocktailCost">â€”</div>
    </div>

    <div class="tile">
      <div class="k">KÃ¢r (1 kokteyl)</div>
      <div class="v" id="profitOne">â€”</div>
    </div>

    <div class="tile light">
      <div class="k">Toplam KÃ¢r (ÅŸiÅŸeden Ã§Ä±kan adet)</div>
      <div class="v" id="profitTotal">â€”</div>
    </div>

    <div class="tile light">
      <div class="k">Tahmini Kar OranÄ±</div>
      <div class="v" id="profitPct">â€”</div>
    </div>
  </section>

  <div class="btns">
    <button class="danger" id="resetBtn" type="button">SÄ±fÄ±rla</button>
  </div>

  <div class="footer">
    GÃ¼ncelleme gÃ¶rÃ¼nmÃ¼yorsa Ctrl+F5 yapÄ±n veya Service Worker cache temizleyin.
    <br><br>
    *Bu hesaplama sadece Pernod Ricard satÄ±ÅŸ ekiplerinin kullanÄ±mÄ±na Ã¶zgÃ¼dÃ¼r ve sadece hesaplama kolaylÄ±ÄŸÄ± saÄŸlamak amacÄ±yla satÄ±ÅŸ ekiplerinin kullanÄ±mÄ± iÃ§in planlanmÄ±ÅŸtÄ±r.
    <br>
    NoktanÄ±n menÃ¼ kokteyl satÄ±ÅŸ fiyatÄ±na yÃ¶nlendirme yapÄ±lmamalÄ±dÄ±r.
  </div>
</main>

<div id="urunPanel" class="dropdown-panel" aria-hidden="true">
  <div class="dropdown-card" role="dialog" aria-modal="true">
    <div class="dropdown-head">
      <div class="input">
        <span style="opacity:.7">Ara</span>
        <input id="urunSearch" placeholder="Yazmaya baÅŸla..." />
      </div>
      <div class="hint" id="urunInfo" style="margin-top:8px">Liste yÃ¼kleniyorâ€¦</div>
    </div>
    <div id="urunList" class="dropdown-listbox"></div>
  </div>
</div>

<script>
/* -----------------------------
   Helpers
----------------------------- */
const $ = (s)=>document.querySelector(s);

function fmtTL(n){
  if(!Number.isFinite(n)) return "â€”";
  return "â‚º " + n.toLocaleString(undefined,{maximumFractionDigits:2});
}
function fmtPct(n){
  if(!Number.isFinite(n)) return "â€”";
  return "% " + n.toFixed(1).replace(".",",");
}
function cleanName(s){
  // BOM + baÅŸtaki/sondaki tÄ±rnak/boÅŸluk temizliÄŸi
  return String(s ?? "")
    .replace(/^\uFEFF/, "")
    .trim()
    .replace(/^[\s"â€œâ€'`]+/, "")
    .replace(/[\s"â€œâ€'`]+$/, "");
}
function toNum(s){
  if(s == null) return NaN;
  const str = String(s).trim();
  if(!str) return NaN;

  // 1.234,56 veya 1,234.56 yaklaÅŸÄ±mlarÄ±
  const normalized = (str.includes(",") && str.includes("."))
    ? str.replace(/\./g,"").replace(",",".")
    : str.replace(",",".");
  const n = Number(normalized);
  return Number.isFinite(n) ? n : NaN;
}

/* -----------------------------
   Elements
----------------------------- */
const els = {
  urunTrigger: $("#urunTrigger"),
  urunPanel: $("#urunPanel"),
  urunSelected: $("#urunSelected"),
  urunSearch: $("#urunSearch"),
  urunList: $("#urunList"),
  urunInfo: $("#urunInfo"),

  price: $("#price"),
  cl: $("#cl"),
  discPct: $("#discPct"),
  usecl: $("#usecl"),
  other: $("#other"),
  sale: $("#sale"),
  qty: $("#qty"),
};

const out = {
  netOut: $("#netOut"),
  cocktailCost: $("#cocktailCost"),
  profitOne: $("#profitOne"),
  profitTotal: $("#profitTotal"),
  profitPct: $("#profitPct"),
};

let urunler = [];

/* -----------------------------
   Modern Dropdown Open/Close
----------------------------- */
function openPanel(){
  els.urunPanel.style.display="flex";
  els.urunPanel.setAttribute("aria-hidden","false");
  els.urunSearch.value="";
  renderUrunList(urunler);
  setTimeout(()=>els.urunSearch.focus(), 0);
}
function closePanel(){
  els.urunPanel.style.display="none";
  els.urunPanel.setAttribute("aria-hidden","true");
}
els.urunTrigger.addEventListener("click", openPanel);
els.urunPanel.addEventListener("click", (e)=>{
  if(e.target === els.urunPanel) closePanel();
});
document.addEventListener("keydown",(e)=>{
  if(e.key === "Escape" && els.urunPanel.style.display==="flex") closePanel();
});

/* -----------------------------
   CSV Load (virgÃ¼l / ; destekli)
   Beklenen kolonlar: ad,fiyat,cl  (sÄ±ra Ã¶nemli)
----------------------------- */
fetch("./urunler.csv", { cache: "no-store" })
  .then(r => {
    if (!r.ok) throw new Error("urunler.csv bulunamadÄ±");
    return r.text();
  })
  .then(text => {
    const cleaned = text.replace(/\r/g, "").trim();
    const lines = cleaned.split("\n").filter(Boolean);
    if (lines.length <= 1) throw new Error("CSV boÅŸ veya sadece baÅŸlÄ±k var");

    const header = lines[0];
    const delimiter = (header.includes(";") && !header.includes(",")) ? ";" : ",";

    const dataLines = lines.slice(1);

    urunler = dataLines.map(line => {
      let s = line.trim();
      if (!s) return null;

      // SatÄ±r komple "..." ÅŸeklinde geliyorsa tÄ±rnaklarÄ± kaldÄ±r
      if (s.startsWith('"') && s.endsWith('"')) s = s.slice(1, -1);

      // ÃœrÃ¼n adÄ±nda ayraÃ§ olabilir â†’ sondan 2 ayraÃ§tan bÃ¶l
      const lastSep = s.lastIndexOf(delimiter);
      const secondLastSep = s.lastIndexOf(delimiter, lastSep - 1);
      if (lastSep === -1 || secondLastSep === -1) return null;

      const adRaw = s.slice(0, secondLastSep);
      const fiyatRaw = s.slice(secondLastSep + 1, lastSep);
      const clRaw = s.slice(lastSep + 1);

      const ad = cleanName(adRaw);
      const fiyat = toNum(fiyatRaw);
      const cl = toNum(clRaw);

      if (!ad || !Number.isFinite(fiyat) || !Number.isFinite(cl)) return null;
      return { ad, fiyat, cl };
    }).filter(Boolean);

    els.urunInfo.textContent = `Toplam ${urunler.length} Ã¼rÃ¼n yÃ¼klendi`;
    renderUrunList(urunler);
  })
  .catch(err => {
    console.error(err);
    els.urunInfo.textContent = "ÃœrÃ¼n listesi yÃ¼klenemedi. urunler.csv formatÄ±nÄ± kontrol edin.";
  });

/* -----------------------------
   Render + Filter + Select
----------------------------- */
function renderUrunList(list){
  els.urunList.innerHTML="";
  if(!list || list.length === 0){
    const empty = document.createElement("div");
    empty.className="dropdown-item";
    empty.textContent="SonuÃ§ bulunamadÄ±";
    empty.style.opacity=".7";
    els.urunList.appendChild(empty);
    return;
  }

  list.slice(0, 400).forEach(u=>{
    const div=document.createElement("div");
    div.className="dropdown-item";
    div.textContent=u.ad;
    div.onclick=()=>{
      els.urunSelected.value=u.ad;
      els.price.value=String(u.fiyat);
      els.cl.value=String(u.cl);
      closePanel();
      calc();
    };
    els.urunList.appendChild(div);
  });
}

els.urunSearch.addEventListener("input", ()=>{
  const q = els.urunSearch.value.toLowerCase();
  const filtered = urunler.filter(u=>u.ad.toLowerCase().includes(q));
  renderUrunList(filtered);
});

/* -----------------------------
   Calculation
----------------------------- */
function calc(){
  const P = toNum(els.price.value);
  const CL = toNum(els.cl.value);

  if(!Number.isFinite(P) || !Number.isFinite(CL) || CL <= 0){
    Object.values(out).forEach(el=>el.textContent="â€”");
    els.qty.value = "1";
    return;
  }

  const discPct = toNum(els.discPct.value);
  const U = toNum(els.usecl.value);
  const O = toNum(els.other.value);
  const S = toNum(els.sale.value);

  // ÅiÅŸeden Ã§Ä±kacak tam kokteyl adedi
  let Q = 1;
  if (Number.isFinite(U) && U > 0) {
    Q = Math.max(1, Math.floor(CL / U));
  }
  els.qty.value = String(Q);

  // Ä°skonto (yÃ¼zde)
  const pct = Number.isFinite(discPct) ? discPct : 0;
  const netBottle = Math.max(0, P - (P * pct / 100));

  // 1 CL maliyeti ve kokteylde kullanÄ±lan alkol maliyeti
  const perCL = netBottle / CL;
  const alcCost = (Number.isFinite(U) && U > 0) ? perCL * U : 0;

  // DiÄŸer maliyet
  const other = Number.isFinite(O) ? O : 0;

  // 1 kokteyl toplam maliyeti
  const cocktailCost = alcCost + other;

  // KÃ¢r
  const sale = Number.isFinite(S) ? S : NaN;
  const profitOne = (Number.isFinite(sale) ? sale : 0) - cocktailCost;
  const profitTotal = profitOne * Q;

  // KÃ¢r oranÄ± (satÄ±ÅŸ fiyatÄ±na gÃ¶re)
  const profitPct = (Number.isFinite(sale) && sale > 0)
    ? (profitOne / sale) * 100
    : NaN;

  out.netOut.textContent = fmtTL(netBottle);
  out.cocktailCost.textContent = fmtTL(cocktailCost);
  out.profitOne.textContent = fmtTL(profitOne);
  out.profitTotal.textContent = fmtTL(profitTotal);
  out.profitPct.textContent = fmtPct(profitPct);
}

["discPct","usecl","other","sale"].forEach(id=>{
  els[id].addEventListener("input", calc);
});

$("#resetBtn").addEventListener("click", ()=>{
  els.urunSelected.value = "";
  els.price.value = "";
  els.cl.value = "";
  els.discPct.value = "";
  els.usecl.value = "";
  els.other.value = "";
  els.sale.value = "";
  els.qty.value = "1";
  Object.values(out).forEach(el=>el.textContent="â€”");
});

calc();

// Service worker (istersen kapatabilirsin; cache sorun Ã§Ä±karÄ±yorsa geÃ§ici olarak yorum satÄ±rÄ±na al)
window.addEventListener("load", ()=>{
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(console.error);
  }
});
</script>
</body>
</html>
